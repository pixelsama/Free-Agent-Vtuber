version: '3.8'

# 开发环境配置 - 支持代码热更新
services:
  # Redis 消息总线
  redis:
    image: redis:7-alpine
    container_name: aivtuber-redis-dev
    ports:
      - "6379:6379"
    volumes:
      - redis_dev_data:/data
    restart: "no"
    command: redis-server --appendonly yes

  # 网关服务
  gateway:
    build:
      context: ./services/gateway-python
      dockerfile: Dockerfile
    container_name: aivtuber-gateway-dev
    ports:
      - "8000:8000"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PYTHONPATH=/app
      - FLASK_ENV=development
      - FLASK_DEBUG=1
      - INPUT_HANDLER_URL=ws://input-handler:8001
      - OUTPUT_HANDLER_URL=ws://output-handler:8002
    volumes:
      - ./services/gateway-python:/app
    restart: "no"
    depends_on:
      - redis

  # 同步主链路：dialog-engine（M1）
  dialog-engine:
    build:
      context: ./services/dialog-engine
      dockerfile: Dockerfile
    container_name: aivtuber-dialog-engine-dev
    environment:
      - PORT=8100
      - PYTHONPATH=/app
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - SYNC_TTS_STREAMING=${SYNC_TTS_STREAMING:-false}
      - OUTPUT_INGEST_WS_URL=ws://output-handler:8002/ws/ingest/tts
    ports:
      - "8100:8100"
    volumes:
      - ./services/dialog-engine:/app/services/dialog-engine
    restart: "no"
    depends_on:
      - redis

  # ASR语音识别服务
  asr:
    build:
      context: ./services/asr-python
      dockerfile: Dockerfile
    container_name: aivtuber-asr-dev
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PYTHONPATH=/app
    volumes:
      - ./services/asr-python:/app
      - ./utils:/app/shared_utils
    command: ["python", "dev_runner.py"]
    restart: "no"
    depends_on:
      - redis

  # 输入处理服务
  input-handler:
    build:
      context: ./services/input-handler-python
      dockerfile: Dockerfile
    container_name: aivtuber-input-handler-dev
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PYTHONPATH=/app
      - ENABLE_SYNC_CORE=${ENABLE_SYNC_CORE:-false}
      - DIALOG_ENGINE_URL=http://dialog-engine:8100
    volumes:
      - ./services/input-handler-python:/app
      - temp_files:/tmp/aivtuber_tasks
    restart: "no"
    depends_on:
      - redis

  # 记忆服务
  memory:
    build:
      context: ./services/memory-python
      dockerfile: Dockerfile
    container_name: aivtuber-memory-dev
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PYTHONPATH=/app
    volumes:
      - ./services/memory-python:/app
      - ./utils:/app/shared_utils
      - memory_dev_data:/app/data
    command: ["python", "dev_runner.py"]
    restart: "no"
    depends_on:
      - redis

  # PostgreSQL数据库 (用于pgvector)
  postgres:
    image: pgvector/pgvector:pg16
    container_name: aivtuber-postgres-dev
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-ltm_vectors}
      - POSTGRES_USER=${POSTGRES_USER:-ltm_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-ltm_password}
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    restart: "no"

  # 长期记忆服务
  long-term-memory:
    build:
      context: ./services/long-term-memory-python
      dockerfile: Dockerfile
    container_name: aivtuber-long-term-memory-dev
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PGVECTOR_HOST=postgres
      - PGVECTOR_PORT=5432
      - PGVECTOR_DATABASE=${POSTGRES_DB:-ltm_vectors}
      - PGVECTOR_USER=${POSTGRES_USER:-ltm_user}
      - PGVECTOR_PASSWORD=${POSTGRES_PASSWORD:-ltm_password}
      - MEM0_CONFIG_PATH=config/mem0_config.yaml
      - PYTHONPATH=/app
    volumes:
      - ./services/long-term-memory-python:/app
      - ltm_dev_data:/app/data
      - ltm_dev_logs:/app/logs
    command: ["python", "dev_runner.py"]
    restart: "no"
    depends_on:
      - redis
      - postgres

  # AI聊天服务
  chat-ai:
    build:
      context: ./services/chat-ai-python
      dockerfile: Dockerfile
    container_name: aivtuber-chat-ai-dev
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PYTHONPATH=/app
      - ENABLE_LTM=${ENABLE_LTM:-true}
      - LTM_REQUESTS_QUEUE=${LTM_REQUESTS_QUEUE:-ltm_requests}
      - LTM_RESPONSES_CHANNEL=${LTM_RESPONSES_CHANNEL:-ltm_responses}
    volumes:
      - ./services/chat-ai-python:/app
      - ./utils:/app/shared_utils
    command: ["python", "dev_runner.py"]
    restart: "no"
    depends_on:
      - redis

  # 输出处理服务
  output-handler:
    build:
      context: ./services/output-handler-python
      dockerfile: Dockerfile
    container_name: aivtuber-output-handler-dev
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PYTHONPATH=/app
    volumes:
      - ./services/output-handler-python:/app
      - temp_files:/tmp/aivtuber_tasks
    restart: "no"
    depends_on:
      - redis

  # TTS语音合成服务
  tts:
    build:
      context: ./services/tts-python
      dockerfile: Dockerfile
    container_name: aivtuber-tts-dev
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PYTHONPATH=/app
    volumes:
      - ./services/tts-python:/app
      - ./utils:/app/shared_utils
      - temp_files:/tmp/aivtuber_tasks
    command: ["python", "dev_runner.py"]
    restart: "no"
    depends_on:
      - redis

volumes:
  redis_dev_data:
  memory_dev_data:
  postgres_dev_data:
  ltm_dev_data:
  ltm_dev_logs:
  temp_files:

networks:
  default:
    name: aivtuber-dev-network
