# Free-Agent-Vtuber 系统架构文档

## 项目概述

Free-Agent-Vtuber 是一个基于事件驱动架构的 AI 虚拟主播系统，采用微服务设计，支持语音识别、AI对话、语音合成、记忆管理等功能。该项目的核心特点是高度解耦的微服务架构，允许灵活扩展和技术栈多样化。

## 系统架构概览

### 架构特点
- **事件驱动 (Event-Driven)**：基于 Redis 消息总线的松耦合架构
- **微服务 (Microservices)**：功能模块独立部署和维护
- **技术异构 (Polyglot)**：支持多种编程语言，目前主要使用 Python
- **容器化部署 (Containerized)**：基于 Docker 的容器化部署
- **可扩展性 (Scalable)**：模块化设计，易于添加新功能

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                           用户交互层                                  │
├─────────────────────────────────────────────────────────────────────┤
│  前端 (Vue.js + Vuetify)  │  管理界面 (Flask)  │  Live2D 虚拟形象    │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                              WebSocket/HTTP
                                    │
┌─────────────────────────────────────────────────────────────────────┐
│                           API 网关层                                  │
├─────────────────────────────────────────────────────────────────────┤
│               Gateway Service (FastAPI + WebSocket)                 │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                Redis 消息总线
                                    │
┌─────────────────────────────────────────────────────────────────────┐
│                          核心服务层                                   │
├─────────────────────────────────────────────────────────────────────┤
│  Input Handler  │  Output Handler  │  Dialog Engine  │  Chat AI     │
│                 │                  │                 │              │
│  ASR Service    │  TTS Service     │  Memory Service │ Long-term    │
│                 │                  │                 │ Memory       │
└─────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────────┐
│                          数据存储层                                   │
├─────────────────────────────────────────────────────────────────────┤
│     Redis          │      PostgreSQL + pgvector      │  文件存储     │
│   (消息队列/缓存)   │      (向量数据库/长期记忆)        │  (临时文件)   │
└─────────────────────────────────────────────────────────────────────┘
```

## 核心组件详解

### 1. 消息总线 (Redis)
- **作用**：系统的中央神经系统，负责服务间通信
- **技术**：Redis 7 Alpine
- **功能**：
  - 消息队列 (List)：任务分发和处理
  - 发布订阅 (Pub/Sub)：事件通知和状态更新
  - 缓存：临时数据存储

### 2. API 网关 (Gateway Service)
- **技术栈**：FastAPI + WebSocket + uvicorn
- **端口**：8000
- **职责**：
  - HTTP API 请求路由
  - WebSocket 连接管理
  - 请求验证和限流
  - 服务发现和负载均衡

### 3. 输入处理服务 (Input Handler)
- **技术栈**：FastAPI + aiofiles
- **功能**：
  - 音频/文本输入归一化
  - 文件上传和临时存储
  - 输入任务队列管理
  - 数据格式转换

### 4. 输出处理服务 (Output Handler)
- **技术栈**：FastAPI + WebSocket
- **功能**：
  - 响应数据格式化
  - 音频流式传输
  - 前端状态同步
  - 临时文件清理

### 5. 语音识别服务 (ASR Service)
- **技术栈**：Python + FunASR/OpenAI Whisper
- **队列**：`asr_tasks` (消费) → `asr_results` (发布)
- **功能**：
  - 音频文件转文本
  - 多种ASR引擎支持
  - 语言检测和处理

### 6. AI 对话服务 (Chat AI Service)
- **技术栈**：Python + OpenAI API
- **通信**：订阅 `memory_updates` → 发布 `ai_responses`
- **功能**：
  - 大语言模型集成
  - 上下文管理
  - 回复生成和优化

### 7. 语音合成服务 (TTS Service)
- **技术栈**：Python + Edge-TTS
- **队列**：`tts_requests` (消费) → `task_response:{task_id}` (发布)
- **功能**：
  - 文本转语音
  - 多种语音选择
  - 音频格式处理

### 8. 记忆服务 (Memory Service)
- **技术栈**：Python + 文件存储
- **队列**：`user_input_queue` (消费) → `memory_updates` (发布)
- **功能**：
  - 短期对话记忆
  - 上下文维护
  - 记忆检索和更新

### 9. 长期记忆服务 (Long-term Memory Service)
- **技术栈**：Python + mem0ai + PostgreSQL/pgvector
- **功能**：
  - 向量化记忆存储
  - 语义搜索
  - 记忆关联和推理

### 10. 对话引擎 (Dialog Engine)
- **功能**：
  - 对话流程控制
  - 多轮对话管理
  - 状态机维护

## 数据流架构

### 端到端数据流 (语音输入 → AI回复 → 语音输出)

```
用户语音输入
    │
    ▼
┌─────────────┐    POST /api/asr    ┌─────────────┐
│   前端界面   │ ─────────────────→ │   Gateway   │
└─────────────┘                    └─────────────┘
                                          │
                                   LPUSH asr_tasks
                                          │
                                          ▼
                                   ┌─────────────┐
                                   │ Redis Queue │
                                   └─────────────┘
                                          │
                                    RPOP asr_tasks
                                          │
                                          ▼
┌─────────────┐  识别结果(pub/sub)  ┌─────────────┐
│ ASR Service │ ─────────────────→ │Input Handler│
└─────────────┘   asr_results      └─────────────┘
                                          │
                               LPUSH user_input_queue
                                          │
                                          ▼
                                   ┌─────────────┐
                                   │ Redis Queue │
                                   └─────────────┘
                                          │
                               RPOP user_input_queue
                                          │
                                          ▼
┌─────────────┐ memory_updates(pub) ┌─────────────┐
│Memory Service│ ─────────────────→ │ Chat AI     │
└─────────────┘                    └─────────────┘
                                          │
                                   ai_responses(pub)
                                   LPUSH tts_requests
                                          │
                                          ▼
                                   ┌─────────────┐
                                   │ Redis Queue │
                                   └─────────────┘
                                          │
                                   RPOP tts_requests
                                          │
                                          ▼
┌─────────────┐ task_response(pub) ┌─────────────┐
│ TTS Service │ ─────────────────→ │Output Handler│
└─────────────┘                    └─────────────┘
                                          │
                                    WebSocket
                                          │
                                          ▼
                                   ┌─────────────┐
                                   │   前端界面   │
                                   └─────────────┘
```

### 消息队列设计

#### List 队列 (任务队列)
- `asr_tasks`：语音识别任务
- `user_input_queue`：用户输入任务
- `tts_requests`：语音合成任务

#### Pub/Sub 频道 (事件通知)
- `asr_results`：ASR 识别结果
- `memory_updates`：记忆更新事件
- `ai_responses`：AI 回复事件
- `task_response:{task_id}`：任务响应

## 部署架构

### 容器化部署
```yaml
# Docker Compose 服务栈
services:
  redis:          # 消息总线
  postgres:       # 长期记忆数据库
  gateway:        # API 网关
  input-handler:  # 输入处理
  output-handler: # 输出处理
  asr:           # 语音识别
  chat-ai:       # AI 对话
  memory:        # 短期记忆
  long-term-memory: # 长期记忆
  tts:           # 语音合成
```

### 网络架构
- **网络名称**：aivtuber-network
- **端口映射**：
  - Gateway: 8000 (HTTP/WebSocket)
  - Redis: 6379 (内部通信)
  - PostgreSQL: 5432 (数据库)

### 数据持久化
```
volumes:
  redis_data:     # Redis 数据持久化
  postgres_data:  # PostgreSQL 数据
  memory_data:    # 短期记忆文件
  ltm_data:       # 长期记忆数据
  ltm_logs:       # 长期记忆日志
  temp_files:     # 临时文件存储
```

## 开发管理架构

### 本地开发管理 (Manager)
- **技术栈**：Flask + psutil + subprocess
- **端口**：5000
- **功能**：
  - 服务生命周期管理
  - 实时状态监控
  - 日志查看
  - 配置管理

### 前端开发
- **技术栈**：Vue.js 3 + Vuetify 3 + Vite
- **功能**：
  - Live2D 虚拟形象展示
  - 实时语音交互
  - 聊天界面
  - 状态监控

## 扩展性设计

### 水平扩展
- 服务无状态设计，支持多实例部署
- Redis 集群支持
- 数据库读写分离

### 功能扩展
- 插件式服务架构
- 标准化消息协议
- 配置驱动的服务发现

### 技术栈扩展
- 支持多语言实现
- 统一消息接口
- 容器化标准部署

## 安全架构

### 数据安全
- 敏感配置环境变量化
- 临时文件自动清理
- API 密钥隔离

### 网络安全
- 内部服务网络隔离
- WebSocket 连接验证
- 请求限流和防护

### 运行时安全
- 容器安全扫描
- 健康检查监控
- 自动重启机制

## 监控和日志

### 健康检查
- Redis: `redis-cli ping`
- PostgreSQL: `pg_isready`
- 服务状态自动检测

### 日志管理
- 结构化日志输出
- 日志等级分类
- 实时日志流监控

### 性能监控
- 消息队列长度监控
- 响应时间统计
- 资源使用率跟踪

## 技术债务和改进方向

### 当前技术债务
1. 缺乏统一的错误处理机制
2. 监控告警系统不完善
3. 测试覆盖率有待提升
4. 配置管理需要标准化

### 未来改进方向
1. 引入服务网格 (Service Mesh)
2. 实现分布式链路追踪
3. 添加指标收集和可视化
4. 完善 CI/CD 流水线
5. 增强安全防护机制

## 开发工作流

### 分支策略
- `main`：主分支，生产就绪代码
- `develop`：开发分支，集成测试
- `feature/*`：功能分支
- `docs/*`：文档分支

### 部署流程
1. 本地开发测试
2. 功能分支合并
3. 集成测试验证
4. 容器镜像构建
5. 生产环境部署

---

**文档版本**: 1.0
**创建日期**: 2025-09-20
**维护者**: AI Architecture Team