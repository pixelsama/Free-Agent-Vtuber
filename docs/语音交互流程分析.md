# Free-Agent-Vtuber è¯­éŸ³äº¤äº’æµç¨‹åˆ†æ

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æç”¨æˆ·åœ¨å‰ç«¯å¼€å¯éº¦å…‹é£å¹¶å‘é€è¯­éŸ³åï¼Œå‰åç«¯åŠåç«¯å„ä¸ªå¾®æœåŠ¡æ¨¡å—ä¹‹é—´çš„å®Œæ•´ä¿¡æ¯æµåŠ¨è¿‡ç¨‹ã€‚

## ç³»ç»Ÿæ¶æ„æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User as ğŸ‘¤ ç”¨æˆ·
    participant Frontend as ğŸŒ å‰ç«¯(Vue.js)
    participant Gateway as ğŸšª GatewayæœåŠ¡
    participant InputHandler as ğŸ“¥ Input-Handler
    participant Redis as ğŸ—ƒï¸ Redisæ¶ˆæ¯æ€»çº¿
    participant ASR as ğŸ™ï¸ ASRæœåŠ¡
    participant Memory as ğŸ§  MemoryæœåŠ¡
    participant ChatAI as ğŸ¤– Chat-AIæœåŠ¡
    participant TTS as ğŸ”Š TTSæœåŠ¡

    %% å‰ç«¯å½•éŸ³é˜¶æ®µ
    Note over User,Frontend: ğŸ¤ å½•éŸ³é˜¶æ®µ
    User->>Frontend: ç‚¹å‡»éº¦å…‹é£æŒ‰é’®
    Frontend->>Frontend: è·å–éº¦å…‹é£æƒé™
    Frontend->>Frontend: MediaRecorderå¼€å§‹å½•éŸ³
    Frontend->>Frontend: æ”¶é›†éŸ³é¢‘Blobæ•°æ®
    User->>Frontend: å†æ¬¡ç‚¹å‡»åœæ­¢å½•éŸ³
    Frontend->>Frontend: è§¦å‘sendAudioInput()

    %% WebSocketè¿æ¥å»ºç«‹
    Note over Frontend,Gateway: ğŸ”Œ WebSocketè¿æ¥å»ºç«‹
    Frontend->>Gateway: è¿æ¥ ws://localhost:8000/ws/input
    Gateway->>Frontend: è¿”å›task_id_assignedæ¶ˆæ¯
    Frontend->>Gateway: è‡ªåŠ¨è¿æ¥ ws://localhost:8000/ws/output/{task_id}

    %% éŸ³é¢‘æ•°æ®ä¼ è¾“
    Note over Frontend,Gateway: ğŸ“¤ éŸ³é¢‘æ•°æ®ä¼ è¾“
    loop æ¯ä¸ªå½•éŸ³å—
        Frontend->>Gateway: å‘é€éŸ³é¢‘å…ƒæ•°æ®JSON
        Frontend->>Gateway: å‘é€éŸ³é¢‘äºŒè¿›åˆ¶æ•°æ®
    end
    Frontend->>Gateway: å‘é€upload_completeä¿¡å·

    %% åç«¯æœåŠ¡é—´å¤„ç†
    Note over Gateway,TTS: ğŸ”„ åç«¯å¾®æœåŠ¡å¤„ç†é“¾è·¯
    Gateway->>InputHandler: WebSocketä»£ç†éŸ³é¢‘æ•°æ®
    InputHandler->>Redis: LPUSHåˆ°asr_tasksé˜Ÿåˆ—
    Note right of Redis: asr_tasksé˜Ÿåˆ—æ ¼å¼:<br/>{task_id, input_file, user_id, source}
    
    ASR->>Redis: RPOPæ¶ˆè´¹asr_tasks
    ASR->>ASR: éŸ³é¢‘è¯†åˆ«å¤„ç†<br/>(fake/OpenAI/FunASR)
    ASR->>Redis: PUBLISHåˆ°asr_resultsé¢‘é“
    Note right of Redis: asr_resultsæ ¼å¼:<br/>{task_id, status: "finished", text, provider, lang}

    %% å…³é”®æ¡¥æ¥æ­¥éª¤
    Note over InputHandler: ğŸŒ‰ å…³é”®æ¡¥æ¥æ­¥éª¤
    InputHandler->>Redis: SUBSCRIBE asr_resultsé¢‘é“
    InputHandler->>InputHandler: è½¬æ¢ä¸ºæ ‡å‡†ç”¨æˆ·è¾“å…¥æ ¼å¼<br/>("Bæ¨¡å¼ï¼šcontentä¼˜å…ˆ")
    InputHandler->>Redis: LPUSHåˆ°user_input_queue
    Note right of Redis: user_input_queueæ ¼å¼:<br/>{task_id, type: "text", content: "è¯†åˆ«æ–‡æœ¬", source: "asr"}

    %% AIå¤„ç†é“¾è·¯
    Memory->>Redis: RPOPæ¶ˆè´¹user_input_queue
    Memory->>Memory: ä¼˜å…ˆè¯»å–contentå­—æ®µ<br/>å­˜å‚¨å¯¹è¯å†å²
    Memory->>Redis: PUBLISHåˆ°memory_updatesé¢‘é“

    ChatAI->>Redis: SUBSCRIBE memory_updatesé¢‘é“
    ChatAI->>ChatAI: è°ƒç”¨AI APIç”Ÿæˆå›å¤
    ChatAI->>Redis: PUBLISHåˆ°ai_responsesé¢‘é“
    ChatAI->>Redis: LPUSHåˆ°tts_requestsé˜Ÿåˆ—

    TTS->>Redis: RPOPæ¶ˆè´¹tts_requests
    TTS->>TTS: è¯­éŸ³åˆæˆ<br/>(Edge-TTS/OpenAI TTS)
    TTS->>Redis: PUBLISHåˆ°task_response:{task_id}

    %% å“åº”è¿”å›å‰ç«¯
    Note over Gateway,Frontend: ğŸ“¥ å“åº”è¿”å›å‰ç«¯
    Gateway->>Redis: SUBSCRIBE task_response:{task_id}
    Gateway->>Frontend: å‘é€æ–‡æœ¬å“åº”JSON
    Gateway->>Frontend: å‘é€éŸ³é¢‘åˆ†ç‰‡å…ƒæ•°æ®
    Gateway->>Frontend: å‘é€éŸ³é¢‘äºŒè¿›åˆ¶æ•°æ®
    Gateway->>Frontend: å‘é€audio_completeä¿¡å·

    Frontend->>Frontend: é‡ç»„éŸ³é¢‘Blob
    Frontend->>Frontend: æ›´æ–°èŠå¤©UIæ˜¾ç¤º
    Frontend->>User: æ˜¾ç¤ºAIå›å¤æ–‡æœ¬å’Œæ’­æ”¾è¯­éŸ³
```

## è¯¦ç»†æµç¨‹åˆ†æ

### ğŸ“± å‰ç«¯è¯­éŸ³å½•åˆ¶æµç¨‹

#### 1. ç”¨æˆ·äº¤äº’è§¦å‘
- ç”¨æˆ·ç‚¹å‡»éº¦å…‹é£æŒ‰é’® (`ChatInterface.vue:76`)
- è°ƒç”¨ `toggleRecording()` æ–¹æ³• (`ChatInterface.vue:169`)  
- è§¦å‘ `useApi.js` ä¸­çš„ `startRecording()` (`useApi.js:401`)

#### 2. å½•éŸ³åˆå§‹åŒ–
```javascript
// useApi.js:416-422
const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
recorder.value = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
```
- è¯·æ±‚éº¦å…‹é£æƒé™
- åˆ›å»º MediaRecorder å®ä¾‹
- è®¾ç½®å½•éŸ³æ ¼å¼ä¸º `audio/webm;codecs=opus`

#### 3. å½•éŸ³æ•°æ®æ”¶é›†
```javascript
// useApi.js:424-428
recorder.value.ondataavailable = (event) => {
    recordedAudioChunks.value.push(event.data);
};
```
- å½•éŸ³æ•°æ®ä»¥ Blob å½¢å¼å­˜å‚¨åœ¨ `recordedAudioChunks` æ•°ç»„ä¸­

### ğŸ”„ WebSocket è¿æ¥ä¸æ•°æ®ä¼ è¾“

#### 4. åœæ­¢å½•éŸ³å¹¶å‘é€
- ç”¨æˆ·å†æ¬¡ç‚¹å‡»æŒ‰é’®æˆ–å½•éŸ³å®Œæˆè§¦å‘ `stopRecording()` (`useApi.js:469`)
- `MediaRecorder.onstop` äº‹ä»¶è§¦å‘ï¼Œè°ƒç”¨ `sendAudioInput()` (`useApi.js:481`)

#### 5. å»ºç«‹ WebSocket è¿æ¥
```javascript
// useApi.js:69-158
const connectInput = () => {
    inputWs.value = new WebSocket(wsInputUrl); // ws://localhost:8000/ws/input
}
```
- å‰ç«¯è¿æ¥åˆ° Gateway çš„è¾“å…¥ WebSocket (`/ws/input`)
- Gateway è¿”å› `task_id_assigned` æ¶ˆæ¯ï¼ŒåŒ…å«ä»»åŠ¡ID
- åŒæ—¶è‡ªåŠ¨è¿æ¥è¾“å‡º WebSocket (`/ws/output/{task_id}`)

#### 6. éŸ³é¢‘æ•°æ®åˆ†ç‰‡ä¼ è¾“
```javascript
// useApi.js:523-547
for (let i = 0; i < chunksToSend.length; i++) {
    // å‘é€å…ƒæ•°æ®
    const metadata = { type: "audio", chunk_id: i, action: "data_chunk" };
    inputWs.value.send(JSON.stringify(metadata));
    
    // å‘é€äºŒè¿›åˆ¶éŸ³é¢‘æ•°æ®
    inputWs.value.send(chunk);
}
```

### ğŸŒ åç«¯æœåŠ¡é—´æ¶ˆæ¯æµåŠ¨

#### 7. Gateway â†’ Input-Handler
**Gateway æœåŠ¡** (`services/gateway-python/main.py`):
- æ¥æ”¶ WebSocket éŸ³é¢‘æ•°æ®
- å°†éŸ³é¢‘æ–‡ä»¶å†™å…¥ä¸´æ—¶å­˜å‚¨
- é€šè¿‡ WebSocket ä»£ç†è½¬å‘åˆ° Input-Handler

#### 8. Input-Handler â†’ ASR é˜Ÿåˆ—
**Input-Handler æœåŠ¡** (`services/input-handler-python/main.py`):
- æ¥æ”¶æ¥è‡ª Gateway çš„éŸ³é¢‘æ–‡ä»¶
- ç”Ÿæˆ ASR ä»»åŠ¡å¹¶æ¨é€åˆ° Redis `asr_tasks` é˜Ÿåˆ—:
```json
{
    "task_id": "uuid",
    "input_file": "/tmp/audio_file.webm", 
    "user_id": "anonymous",
    "source": "websocket"
}
```

#### 9. ASR æœåŠ¡å¤„ç†
**ASR æœåŠ¡** (`services/asr-python/`):
- ä» `asr_tasks` é˜Ÿåˆ—æ¶ˆè´¹ä»»åŠ¡
- éŸ³é¢‘è¯†åˆ«å¤„ç†ï¼ˆæ”¯æŒ fake/OpenAI Whisper/FunASRï¼‰
- å‘å¸ƒè¯†åˆ«ç»“æœåˆ° `asr_results` é¢‘é“:
```json
{
    "task_id": "uuid",
    "status": "finished",
    "text": "è¯†åˆ«åˆ°çš„æ–‡å­—å†…å®¹",
    "provider": "fake|openai_whisper|funasr_local",
    "lang": "zh"
}
```

#### 10. Input-Handler æ¡¥æ¥ â­ï¸
**Input-Handler çš„ ASR æ¡¥æ¥åŠŸèƒ½**ï¼ˆç³»ç»Ÿå…³é”®èŠ‚ç‚¹ï¼‰:
- è®¢é˜… `asr_results` é¢‘é“
- å°† ASR ç»“æœè½¬æ¢ä¸ºæ ‡å‡†ç”¨æˆ·è¾“å…¥æ ¼å¼
- æ¨é€åˆ° `user_input_queue` é˜Ÿåˆ—ï¼ˆ**å…³é”®æ¡¥æ¥æ­¥éª¤**ï¼‰:
```json
{
    "task_id": "æ²¿ç”¨ASR task_id",
    "type": "text", 
    "content": "è¯†åˆ«æ–‡æœ¬å†…å®¹",
    "source": "asr",
    "meta": {
        "from_channel": "asr_results",
        "provider": "fake|openai_whisper|funasr_local"
    }
}
```

#### 11. Memory â†’ Chat-AI â†’ TTS é“¾è·¯
**Memory æœåŠ¡**:
- æ¶ˆè´¹ `user_input_queue`ï¼Œä¼˜å…ˆè¯»å– `content` å­—æ®µ
- å­˜å‚¨ç”¨æˆ·å¯¹è¯å†å²
- å‘å¸ƒåˆ° `memory_updates` é¢‘é“

**Chat-AI æœåŠ¡**:
- è®¢é˜… `memory_updates`
- è°ƒç”¨ AI API ç”Ÿæˆå›å¤
- åŒæ—¶å‘å¸ƒåˆ° `ai_responses` é¢‘é“å’Œæ¨é€åˆ° `tts_requests` é˜Ÿåˆ—

**TTS æœåŠ¡**:
- æ¶ˆè´¹ `tts_requests` é˜Ÿåˆ—
- è¯­éŸ³åˆæˆï¼ˆEdge-TTS/OpenAI TTSï¼‰
- å‘å¸ƒç»“æœåˆ° `task_response:{task_id}` é¢‘é“

### ğŸ“¤ å“åº”è¿”å›å‰ç«¯

#### 12. Output WebSocket æ•°æ®æµ
**Gateway Output WebSocket**:
- è®¢é˜… `task_response:{task_id}` é¢‘é“
- æ¥æ”¶åˆ°æ–‡æœ¬å’ŒéŸ³é¢‘å“åº”
- é€šè¿‡ WebSocket å‘é€ç»™å‰ç«¯:

```javascript
// æ–‡æœ¬å“åº”
{
    "status": "success",
    "task_id": "uuid",
    "content": "AIå›å¤æ–‡æœ¬", 
    "audio_present": true
}

// éŸ³é¢‘åˆ†ç‰‡
{
    "type": "audio_chunk",
    "chunk_id": 0,
    "total_chunks": 3
}
// + äºŒè¿›åˆ¶éŸ³é¢‘æ•°æ®

// éŸ³é¢‘å®Œæˆ
{
    "type": "audio_complete",
    "task_id": "uuid"
}
```

#### 13. å‰ç«¯æ¸²æŸ“å“åº”
**å‰ç«¯å¤„ç†** (`ChatInterface.vue`):
- `receivedText` watcher æ£€æµ‹åˆ°æ–‡æœ¬ï¼Œæ·»åŠ åˆ°èŠå¤©ç•Œé¢
- éŸ³é¢‘æ•°æ®é‡æ–°ç»„è£…ä¸º Blobï¼Œåˆ›å»ºæ’­æ”¾ URL
- UI æ›´æ–°å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·ä¸‹æ¬¡äº¤äº’

## ğŸ” å…³é”®ä¿¡æ¯æµæ€»ç»“

### å®Œæ•´æ•°æ®æµè·¯å¾„
```
å‰ç«¯å½•éŸ³ â†’ Gateway WS â†’ Input-Handler â†’ Redis asr_tasks 
â†’ ASR æœåŠ¡ â†’ Redis asr_results â†’ Input-Handler(æ¡¥æ¥) 
â†’ Redis user_input_queue â†’ Memory â†’ Chat-AI â†’ TTS 
â†’ Redis task_response:{task_id} â†’ Gateway Output WS â†’ å‰ç«¯æ˜¾ç¤º
```

### Redis æ¶ˆæ¯é€šé“è¯´æ˜
| é€šé“/é˜Ÿåˆ—å | ç±»å‹ | ä½œç”¨ | æ•°æ®æ ¼å¼ |
|------------|------|------|----------|
| `asr_tasks` | Listé˜Ÿåˆ— | éŸ³é¢‘è¯†åˆ«ä»»åŠ¡ | `{task_id, input_file, user_id, source}` |
| `asr_results` | Pub/Subé¢‘é“ | ASRè¯†åˆ«ç»“æœ | `{task_id, status, text, provider, lang}` |
| `user_input_queue` | Listé˜Ÿåˆ— | æ ‡å‡†åŒ–ç”¨æˆ·è¾“å…¥ | `{task_id, type, content, source, meta}` |
| `memory_updates` | Pub/Subé¢‘é“ | è®°å¿†å­˜å‚¨é€šçŸ¥ | è®°å¿†æ›´æ–°äº‹ä»¶ |
| `ai_responses` | Pub/Subé¢‘é“ | AIå›å¤å“åº” | AIç”Ÿæˆçš„å›å¤å†…å®¹ |
| `tts_requests` | Listé˜Ÿåˆ— | è¯­éŸ³åˆæˆè¯·æ±‚ | TTSåˆæˆä»»åŠ¡ |
| `task_response:{task_id}` | Pub/Subé¢‘é“ | ä»»åŠ¡æœ€ç»ˆå“åº” | æ–‡æœ¬+éŸ³é¢‘å“åº”æ•°æ® |

### å…³é”®æ¶æ„ç‰¹ç‚¹

1. **äº‹ä»¶é©±åŠ¨**: æ‰€æœ‰æœåŠ¡é€šè¿‡ Redis æ¶ˆæ¯æ€»çº¿è§£è€¦é€šä¿¡
2. **Bæ¨¡å¼ï¼šcontentä¼˜å…ˆ**: Input-Handler æ¡¥æ¥å±‚ç»Ÿä¸€æ•°æ®æ ¼å¼ï¼Œä¼˜å…ˆä½¿ç”¨ `content` å­—æ®µ
3. **å¼‚æ­¥å¤„ç†**: WebSocket åŒå‘é€šä¿¡æ”¯æŒå®æ—¶éŸ³é¢‘æµä¼ è¾“
4. **æ¨¡å—åŒ–è®¾è®¡**: æ¯ä¸ªæœåŠ¡èŒè´£å•ä¸€ï¼Œå¯ç‹¬ç«‹å¼€å‘éƒ¨ç½²

### å…³é”®æ¡¥æ¥ç‚¹
**Input-Handler çš„ ASR ç»“æœæ¡¥æ¥åŠŸèƒ½**æ˜¯æ•´ä¸ªè¯­éŸ³æµç¨‹çš„æ ¸å¿ƒï¼Œå®ƒå°† ASR è¯†åˆ«ç»“æœæ ‡å‡†åŒ–ä¸ºç»Ÿä¸€çš„ç”¨æˆ·è¾“å…¥æ ¼å¼ï¼Œè¿™æ˜¯ "Bæ¨¡å¼ï¼šcontentä¼˜å…ˆ" æ¶æ„çš„å…³é”®å®ç°ã€‚è¿™ä¸ªæ¡¥æ¥ç¡®ä¿äº†æ— è®ºè¾“å…¥æ¥æºï¼ˆASRã€ç”¨æˆ·ç›´æ¥è¾“å…¥ã€ç³»ç»Ÿæ¶ˆæ¯ï¼‰ï¼Œåç»­çš„ Memory å’Œ Chat-AI æœåŠ¡éƒ½èƒ½ä»¥ç»Ÿä¸€çš„æ ¼å¼å¤„ç†æ•°æ®ã€‚

## æŠ€æœ¯æ ˆæ€»ç»“

- **å‰ç«¯**: Vue.js 3 + WebSocket + MediaRecorder API
- **åç«¯ç½‘å…³**: FastAPI + WebSocket ä»£ç†
- **æ¶ˆæ¯æ€»çº¿**: Redis (Listé˜Ÿåˆ— + Pub/Subé¢‘é“)
- **å¾®æœåŠ¡**: Python FastAPI å¼‚æ­¥æœåŠ¡
- **éŸ³é¢‘å¤„ç†**: WebM/Opus â†’ ASR â†’ TTS â†’ MP3
- **AIé›†æˆ**: OpenAIå…¼å®¹API (GPT/Geminiç­‰)